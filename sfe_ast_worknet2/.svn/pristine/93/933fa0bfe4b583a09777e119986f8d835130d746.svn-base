<script>function Main(){var $=this;$.host=null;$.panMain=null;$.grdList=null;$.btnReceive=null;$.btnCancelProc=null;$.btnEtcProc=null;$.btnSuccess=null;$.btnCancel=null;$.lblApprovalAmt=null;$.speApprovalAmt=null;$.btnPrint=null;$.panFooter=null;$.btnIWCProc=null;$.btnMemoSave=null;$.varApprovalNo1="";$.varApprovalNo2="";function createJSON_Q(workType){var json=createExecuteParamInfo("P_crmEseroApprovalSub_Q",[workType,"#UserID#"]);return json}function createJSON_S(workType){var json="";var rows=[];for(var i=0;i<$.grdList.getRowCount();i++){if($.grdList.getValue(i,"CHECKYN")=="Y"||$.grdList.getValue(i,"CHECKYN")==true){rows.push([workType,$.grdList.getValue(i,"APPRNO"),$.grdList.getValue(i,"MEMO"),"","",""])}}if(rows.length<1){return false}json=createExecuteParamInfo("P_crmESEROMAS_S",rows);return json}function createJSON_S2(workType){var json=createExecuteParamInfo("P_crmEseroApprovalSub_S",[workType,$.varApprovalNo1||"",$.varApprovalNo2||""]);return json}function searchList(workType){var json=createJSON_Q(workType);callQuery(["req",json],workType,$)}function saveESEROMAS(workType){var json=createJSON_S(workType);if(json){var ds=callExecuteSync(["req",json],workType,$);if(ds){if(ds.errorCode.substring(0,1)=="P"||ds.errorCode.substring(0,1)=="E"){MessageBoxShow(ds.errorCode+"</br>"+ds.errorMsg)}else{MessageBoxShow("정상적으로 처리되었습니다.");searchList("Q");$.speApprovalAmt.setValue(0)}}}}function saveEseroApprovalSub(workType){var json=createJSON_S2(workType);var ds=callExecuteSync(["req",json],workType,$);if(ds){if(ds.errorCode.substring(0,1)=="P"||ds.errorCode.substring(0,1)=="E"){MessageBoxShow(ds.errorCode+"</br>"+ds.errorMsg)}else{MessageBoxShow("정상적으로 처리되었습니다.");searchList("Q");$.speApprovalAmt.setValue(0)}}}function fnPrint(workType){var json=createJSON_Q3("Q");callQuery(["req",json],"Q3",$)}function createJSON_Q3(workType){var rId=$.grdList.getSelectedRowIdx();var json=createExecuteParamInfo("P_crmEseroApprovalSub_Q2",[workType,$.grdList.getValue(rId,"APPRNO")]);return json}function fnPrint2(workType){var json=createJSON_Q4("Q");callQuery(["req",json],"Q4",$)}function createJSON_Q4(workType){var rId=$.grdList.getSelectedRowIdx();var json=createExecuteParamInfo("P_crmEseroApprovalSub_Q2",[workType,$.grdList.getValue(rId,"APPRNO")]);return json}function newRow(){return{CHECKYN:"N",FTRFLG:"",FTRFLG_NAME:"",VAT_DEDUCT_YN:"",APPDAT:"",BIZNAME:"",BIZNUM:"",APPAMT:0,TAXAMT:0,TOTAMT:0,PRODUCT:"",PRODUCT1:"",DESCR:"",APPRNO:"",BIZTYPE:"",CHANGE:"",RegYN:"",account_comp_name:"",account_comp_code:"",TAX_YN:"",receipt_type:""}}$.init=function(host,args){$.panMain=new FingerPanel(host,"panMain",0,0,1100,385);$.panMain.setText("");$.panMain.setBottomLine(true);$.grdList=new FingerDataGrid(host,"grdList",0,0,1100,320);$.btnReceive=new FingerButton(host,"btnReceive",20,20,120,20);$.btnReceive.setText("계산서 받기");$.btnCancelProc=new FingerButton(host,"btnCancelProc",230,20,120,20);$.btnCancelProc.setText("취소분 처리");$.btnEtcProc=new FingerButton(host,"btnEtcProc",335,20,120,20);$.btnEtcProc.setText("예산불용처리");$.btnSuccess=new FingerButton(host,"btnSuccess",955,20,80,20);$.btnSuccess.setText("확인");$.btnCancel=new FingerButton(host,"btnCancel",1020,20,80,20);$.btnCancel.setText("취소");$.lblApprovalAmt=new FingerLabel(host,"lblApprovalAmt",675,20,100,20);$.lblApprovalAmt.setText("승인금액 계");$.speApprovalAmt=new FingerSpinEdit(host,"speApprovalAmt",780,20,140,20);$.btnPrint=new FingerButton(host,"btnPrint",560,20,130,20);$.btnPrint.setText("전자세금계산서");$.panFooter=new FingerPanel(host,"panFooter",0,320,1100,65);$.panFooter.setText("");$.panFooter.setBottomLine();$.btnIWCProc=new FingerButton(host,"btnIWCProc",440,20,135,20);$.btnIWCProc.setText("무환수입처리");$.btnMemoSave=new FingerButton(host,"btnMemoSave",125,20,120,20);$.btnMemoSave.setText("메모 저장");$.speApprovalAmt.setReadOnly(true);$.btnReceive.setEnable(false);$.btnEtcProc.setEnable(false);$.btnPrint.setVisible(false);$.btnIWCProc.setEnable(false);colMap=$.grdList.setColumns([new FingerDataGridColumn("CHECKYN",50,"center","checkbox","선택"),new FingerDataGridColumn("FTRFLG",99,"center","string","구분코드",{readonly:true}),new FingerDataGridColumn("FTRFLG_NAME",70,"center","string","구분",{readonly:true}),new FingerDataGridColumn("VAT_DEDUCT_YN",75,"center","string","부가세"),new FingerDataGridColumn("APPDAT",90,"center","string","작성일자",{readonly:true}),new FingerDataGridColumn("BIZNAME",150,"left","string","상호",{readonly:true}),new FingerDataGridColumn("BIZNUM",110,"center","string","사업자등록번호",{readonly:true}),new FingerDataGridColumn("APPAMT",90,"right","string","공급가액",{format:"int",readonly:true}),new FingerDataGridColumn("TAXAMT",80,"right","string","세액",{format:"int",readonly:true}),new FingerDataGridColumn("TOTAMT",90,"right","string","합계액",{format:"int",readonly:true}),new FingerDataGridColumn("PRODUCT",180,"left","string","품목",{readonly:true}),new FingerDataGridColumn("PRODUCT1",150,"left","string","품목1",{readonly:true}),new FingerDataGridColumn("MEMO",300,"left","string","메모"),new FingerDataGridColumn("DESCR",150,"left","string","비고",{readonly:true}),new FingerDataGridColumn("APPRNO",180,"left","string","승인번호",{readonly:true}),new FingerDataGridColumn("IMPORTNO",180,"left","string","수입신고번호",{readonly:true}),new FingerDataGridColumn("BIZTYPE",150,"left","string","업태",{readonly:true}),new FingerDataGridColumn("CHANGE",150,"left","string","수정사유",{readonly:true}),new FingerDataGridColumn("RegYN",99,"left","string","미등록거래처 여부",{readonly:true}),new FingerDataGridColumn("account_comp_name",99,"left","string","회계거래처",{readonly:true}),new FingerDataGridColumn("account_comp_code",99,"left","string","회계거래처코드",{readonly:true}),new FingerDataGridColumn("TAX_YN",99,"left","string","유형",{readonly:true}),new FingerDataGridColumn("receipt_type",99,"left","string","계산서유형",{readonly:true})]);$.grdList.init({panel:$.panList,scroll:"xy",eventCellReadOnly:true});$.grdList.setEditable(true);$.grdList.setColumnHidden(["FTRFLG","RegYN","account_comp_name","account_comp_code","TAX_YN","receipt_type"],true);$.grdList.setBorder(false);$.host=host;$.args=args};$.start=function(){$.panMain.add($.grdList);$.panMain.add($.panFooter);$.panFooter.add($.btnReceive);$.panFooter.add($.btnCancelProc);$.panFooter.add($.btnEtcProc);$.panFooter.add($.btnSuccess);$.panFooter.add($.btnCancel);$.panFooter.add($.lblApprovalAmt);$.panFooter.add($.speApprovalAmt);$.panFooter.add($.btnPrint);$.panFooter.add($.btnIWCProc);$.panFooter.add($.btnMemoSave);$.varNonFooter=false;if($.p_argument){if($.p_argument.nonFooter){$.varNonFooter=true}}if($.varNonFooter){if($.p_argument.home_yn){$.btnSuccess.setVisible(false);$.btnEtcProc.setVisible(false);$.btnCancelProc.setVisible(false);$.btnIWCProc.setVisible(false);$.btnPrint.setVisible(false)}else{$.panFooter.setVisible(false);$.grdList.setSize(1100,380);$.grdList.setColumnHidden(["CHECKYN"],true)}}var ds=bizComponentData2($,"Q2","L_CRM268");$.grdList.setColumnDropDownList("VAT_DEDUCT_YN",ds.resultList[0]);searchList("Q");searchList("Q1")};$.callback=function(type,ds){if(type=="Q"){setDataGrid([$.grdList],ds);var userId=g_main.session.obj.EmpCode;var deptCode=g_main.session.obj.DeptCode;var sysDeptCode=g_main.session.obj.SystemDeveloper;if(deptCode=="G120"||deptCode=="D140"||deptCode=="A120"){$.btnEtcProc.setEnable(true)}if(deptCode=="G120"||deptCode=="U120"||deptCode=="A120"||deptCode=="E150"||deptCode=="F280"||deptCode=="E110"||deptCode=="C220"||deptCode=="U140"||deptCode=="D140"||deptCode=="F310"){$.btnIWCProc.setEnable(true)}if(userId=="ka130276"){$.btnEtcProc.setEnable(true)}for(var i=0;i<$.grdList.getRowCount();i++){if($.grdList.getValue(i,"FTRFLG")=="00"){$.btnReceive.setEnable(true);break}}if(ds.resultList[0].length>0){var obj=Object.keys(ds.resultList[0][0]);for(var i=0;i<$.grdList.getRowCount();i++){for(var j=0;j<obj.length;j++){if($.grdList.getValue(i,"FTRFLG")=="00"){if(obj[j]=="CHECKYN"){continue}$.grdList.setCellStyle(i,obj[j],{color:"violet !important"})}else{if($.grdList.getValue(i,"end_yn")=="Y"){if(obj[j]=="CHECKYN"){continue}$.grdList.setCellStyle(i,obj[j],{color:"red !important"})}}}}}$.grdList.selectRow(0)}else{if(type=="Q1"){$.speApprovalAmt.setValue(ds.resultList[0][0].receipt_cnt)}else{if(type=="Q3"||type=="Q4"){var Prod=[];for(var i=1;i<ds.resultList.length;i++){if(ds.resultList[i][0]){Prod.push(ds.resultList[i][0])}}$.reportObj={};$.reportObj.Info=ds.resultList[0];$.reportObj.Prod=Prod;var params={report:"report_Esro",isPrint:false,data:$.reportObj};g_printBrowser.callPrint(params)}}}};$.update=function(args){$.args=args};$.executeScript=function(script){eval(script)};$.fingerbutton_click=function(id){if(id=="btnReceive"){var chk=false;for(var i=0;i<$.grdList.getRowCount();i++){if($.grdList.getValue(i,"CHECKYN")=="Y"||$.grdList.getValue(i,"CHECKYN")==true){chk=true;if($.grdList.getValue(i,"FTRFLG")!="00"){MessageBoxShow("전달 대기중인 세금계산서 및 계산서만 선택 가능합니다.");return}}}if(!chk){MessageBoxShow("선택된 계산서가 없습니다.");return}saveESEROMAS("RECEIVE")}else{if(id=="btnCancelProc"){var chknum=0,biznum1="",biznum2="",appamt1=0,appamt2=0,taxamt1=0,taxamt2=0,appdat1="",appdat2="";for(var i=0;i<$.grdList.getRowCount();i++){if($.grdList.getValue(i,"CHECKYN")=="Y"||$.grdList.getValue(i,"CHECKYN")==true){chknum++}}if(chknum!=2){MessageBoxShow("전자세금계산서는 두건씩 취소분 처리가 가능합니다.");return}chknum=0;for(var i=0;i<$.grdList.getRowCount();i++){if($.grdList.getValue(i,"CHECKYN")=="Y"||$.grdList.getValue(i,"CHECKYN")==true){chknum++;if(chknum==1){biznum1=$.grdList.getValue(i,"BIZNUM");appamt1=$.grdList.getValue(i,"APPAMT");taxamt1=$.grdList.getValue(i,"TAXAMT");$.varApprovalNo1=$.grdList.getValue(i,"APPRNO");appdat1=$.grdList.getValue(i,"APPDAT").substring(0,7)}else{if(chknum==2){biznum2=$.grdList.getValue(i,"BIZNUM");appamt2=$.grdList.getValue(i,"APPAMT");taxamt2=$.grdList.getValue(i,"TAXAMT");$.varApprovalNo2=$.grdList.getValue(i,"APPRNO");appdat2=$.grdList.getValue(i,"APPDAT").substring(0,7)}}}}if(biznum1==biznum2&&Math.abs(appamt1)==Math.abs(appamt2)&&Math.abs(taxamt1)==Math.abs(taxamt2)&&((Number(appamt1)+Number(appamt2))==0)&&appdat1==appdat2){saveEseroApprovalSub("S")}else{MessageBoxShow("취소분처리 시 사업자번호, 작성년월, 금액, 부가세액이 일치해야 합니다.")}}else{if(id=="btnEtcProc"){var chknum=0;for(var i=0;i<$.grdList.getRowCount();i++){if($.grdList.getValue(i,"CHECKYN")=="Y"||$.grdList.getValue(i,"CHECKYN")==true){chknum++}}if(chknum!=1){MessageBoxShow("예산불용처리는 한건씩 처리가 가능합니다.");return}confirmBoxShow("예산처리하지않는 세금계산서가 맞습니까?",function(){if(g_main.msgShare==true){for(var i=0;i<$.grdList.getRowCount();i++){if($.grdList.getValue(i,"CHECKYN")=="Y"||$.grdList.getValue(i,"CHECKYN")==true){$.varApprovalNo1=$.grdList.getValue(i,"APPRNO");$.varApprovalNo2=""}}saveEseroApprovalSub("S1")}})}else{if(id=="btnSuccess"){var chknum=0;if($.grdList.getRowCount()<=0){return}for(var i=0;i<$.grdList.getRowCount();i++){if($.grdList.getValue(i,"CHECKYN")=="Y"||$.grdList.getValue(i,"CHECKYN")==true){if($.grdList.getValue(i,"FTRFLG")=="00"){MessageBoxShow("전달 대기중인 세금계산서 또는 계산서가 선택되었습니다. 계산서 받기를 먼저 진행해 주시기 바랍니다.");return}chknum++}}if(chknum!=1){MessageBoxShow("세금계산서는 한 건씩 처리가 가능합니다.");return}var params={};for(var i=0;i<$.grdList.getRowCount();i++){if($.grdList.getValue(i,"CHECKYN")=="Y"||$.grdList.getValue(i,"CHECKYN")==true){params.FTRFLG=$.grdList.getValue(i,"FTRFLG");params.FTRFLG_NAME=$.grdList.getValue(i,"FTRFLG_NAME");params.VAT_DEDUCT_YN=$.grdList.getValue(i,"VAT_DEDUCT_YN");params.APPDAT=$.grdList.getValue(i,"APPDAT");params.BIZNAME=$.grdList.getValue(i,"BIZNAME");params.BIZNUM=$.grdList.getValue(i,"BIZNUM");params.APPAMT=$.grdList.getValue(i,"APPAMT");params.TAXAMT=$.grdList.getValue(i,"TAXAMT");params.TOTAMT=$.grdList.getValue(i,"TOTAMT");params.PRODUCT=$.grdList.getValue(i,"PRODUCT");params.PRODUCT1=$.grdList.getValue(i,"PRODUCT1");params.DESCR=$.grdList.getValue(i,"DESCR");params.APPRNO=$.grdList.getValue(i,"APPRNO");params.BIZTYPE=$.grdList.getValue(i,"BIZTYPE");params.CHANGE=$.grdList.getValue(i,"CHANGE");params.RegYN=$.grdList.getValue(i,"RegYN");params.account_comp_name=$.grdList.getValue(i,"account_comp_name");params.account_comp_code=$.grdList.getValue(i,"account_comp_code");params.TAX_YN=$.grdList.getValue(i,"TAX_YN");params.receipt_type=$.grdList.getValue(i,"receipt_type")}}g_popupStack.setData([params]);g_popupStack.close()}else{if(id=="btnCancel"){g_popupStack.close()}else{if(id=="btnPrint"){var rId=$.grdList.getSelectedRowIdx();if(rId<0){return}else{if($.grdList.getValue(rId,"TAX_YN")=="Y"){fnPrint()}else{if($.grdList.getValue(rId,"TAX_YN")=="N"){fnPrint2()}}}g_popupStack.close()}else{if(id=="btnIWCProc"){var chknum=0;var rId=$.grdList.getSelectedRowIdx();if(!rId){return}var data=$.grdList.getAllRows();for(var i in data){if(data[i].CHECKYN=="Y"){if(data[i].FTRFLG=="00"){MessageBoxShow("전달 대기중인 세금계산서 또는 계산서가 선택되었습니다. 계산서 받기를 먼저 진행해 주시기 바랍니다.");return}else{chknum++}}}var total_appamt=0;var total_taxamt=0;var total_cnt=0;for(var i in data){if(data[i].BIZNUM=="121-83-00561"&&data[i].FTRFLG=="10"){total_appamt+=-Number(data[i].APPAMT);total_taxamt+=Number(data[i].TAXAMT);total_cnt++;$.grdList.setValue(i,"CHECKYN","Y")}else{$.grdList.setValue(i,"CHECKYN","N")}}var rsArr=[];confirmBoxShow(total_cnt+"건에 대한 무환수입을 진행하시겠습니까? (총 공급가액 : "+Math.abs(total_appamt)+"원, 총 부가세액 : "+total_taxamt+"원)",function(){if(g_main.msgShare==true){var obj=newRow();obj.receipt_type="10";obj.APPDAT=getToday("-");obj.APPAMT=total_appamt;obj.TAXAMT=total_taxamt;obj.modify_yn="N";rsArr.push(obj);for(var i in data){if(data[i].CHECKYN=="Y"){rsArr.push(deepCopyObj(data[i]))}}g_popupStack.setData(rsArr);g_popupStack.close()}})}else{if(id=="btnMemoSave"){saveESEROMAS("MEMOSAVE")}}}}}}}}};$.fingermultiselect_checkchange=function(id,index){};$.fingermultiselect_itemchange=function(id){};$.fingerbuttonedit_click=function(id){};$.fingerbuttonedit_change=function(id,value){};$.fingerbuttonedit_keypress=function(id,value){};$.fingerbuttonedit_lostfocus=function(id,value){};$.fingercheckbox_change=function(id,value){};$.fingercombobox_change=function(id,value){};$.fingerdateedit_click=function(id){};$.fingerdateedit_change=function(id,value){};$.fingerdatagrid_itemclick=function(id,rId,cInd){};$.fingerdatagrid_selectionchange=function(id,rId){if(id=="grdList"){$.btnPrint.setVisible(true)}};$.fingerdatagrid_cellvaluechange=function(id,rId,cInd,nValue,oValue){if(id=="grdList"){if(cInd=="CHECKYN"){if($.grdList.getValue(rId,"FTRFLG")!="10"&&$.grdList.getValue(rId,"FTRFLG")!="00"){$.grdList.setValue(rId,cInd,"N");return}if($.grdList.getValue(rId,"RegYN")=="Y"){MessageBoxShow("등록되지 않은 회계거래처는 선택불가 입니다.");$.grdList.setValue(rId,cInd,"N");return}if($.grdList.getValue(rId,"end_yn")=="Y"){MessageBoxShow("부가가치세 신고기간이 지난 전자(세금)계산서이므로 회계팀에 문의 하십시오.");return}var sumAmt=0;for(var i=0;i<$.grdList.getRowCount();i++){if($.grdList.getValue(i,"CHECKYN")=="Y"||$.grdList.getValue(i,"CHECKYN")==true){sumAmt+=Number($.grdList.getValue(i,"APPAMT"))}}$.speApprovalAmt.setValue(sumAmt)}}};$.fingerdatagrid_rowdblclicked=function(id,rId,cInd){};$.fingerdatagrid_celllink_click=function(e,gridid,rId,cId,value){};$.fingerdatagrid_popupcelldblclicked=function(id,rId,cInd){};$.fingerdatagrid_drag=function(id,sId,tId,sObj,tObj,sInd,tInd){};$.fingeredit_change=function(id,value){};$.fingeredit_keypress=function(id,value){};$.fingeredit_lostfocus=function(id,value){};$.fingerlayout_panelresizefinish=function(id){};$.fingerlayout_resizefinish=function(id){};$.fingerpanel_button_click=function(panelId,btnId){};$.fingerpopup_close=function(id){};$.fingerpopup2_close=function(id){};$.fingerradiobox_change=function(id,value){};$.fingertab_selectionchange=function(id,tabid){};$.fingertab_ontabclose=function(id,tabid){};$.fingertree_select=function(id,value){};$.fingertree_dblclick=function(id,nodeid){};$.fingertree_refresh=function(id){};$.fingerscheduler_before_event_changed=function(id,event_object,native_event,is_new,unmodified_event){};$.fingerscheduler_before_event_delete=function(id,event_id,event_object){};$.fingerscheduler_event_click=function(id,event_id,event_object,native_event_object){};$.fingerscheduler_ready=function(id){};$.fingerscheduler_before_event_created=function(id,start_date,end_date){};$.fingerscheduler_view_display=function(id,view){};$.fingerscheduler_event_reg=function(id,obj){};$.fingerfilepanel_upload_click=function(id,fileId,fileName){};$.fingerfilepanel_download_click=function(id,fileId,fileName){};$.fingerfilepanel_delete_click=function(id,fileId,fileName){};$.fingerimage_click=function(id){};$.fingerimage_change=function(id,value){};$.fingerimage_rotate=function(id,value){};$.fingertab_click=function(id,tabid){};$.fingerpopup_click_x_button=function(){};$.fingeriframe_onload=function(id){};$.fingerhtmlview_click=function(id){}};</script>