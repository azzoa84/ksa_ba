<script>function Main(){var $=this;$.host=null;$.panMain=null;$.panTop=null;$.lblFy=null;$.dteFy=null;$.lblVersion=null;$.cmbVersion=null;$.lblBrand=null;$.mtBrand=null;$.btnSearch=null;$.btnExcelDownload=null;$.btnExcelUpload=null;$.panExpense=null;$.grdExpense=null;$.grdExcel=null;$.colNameList=[];$.popUpCallId="";$.isDebug=true;function createJSON_Q(workType,arr){var json=createExecuteParamInfo("P_bgtExpenseManage_Q",[workType,($.dteFy.getValue()||""),"",($.cmbVersion.getValue()||""),($.mtBrand.getSelectedCodeList()||""),(arr?arr[0]:""),(arr?arr[1]:""),(arr?arr[2]:""),(arr?arr[3]:""),"INPUT","#UserID#"]);return json}function getFYDate(){var nowDate=getToday();var year=Number(nowDate.substr(0,4));var month=Number(nowDate.substr(4,2));if(month<4){$.dteFy.setValue(year-1)}else{$.dteFy.setValue(year)}}function searchBrand(workType){var json=createJSON_Q(workType);callQuery(["req",json],"EXPENSE_BRAND",$)}function searchFCST(workType){var json=createJSON_Q(workType);var ds=callQuerySync(["req",json],"EXPENSE_FCST");return ds}function searchBudgetVersion(workType){var json=createJSON_Q(workType);callQuery(["req",json],"EXPENSE_VERSION",$)}function searchList(workType,arr){if(!$.panTop.validateControls()){return}if(!brandChk()){return}var json=createJSON_Q(workType,arr);callQuery(["req",json],"EXPENSE_LIST",$)}function downloadExcelForm(workType){var json=createJSON_Q(workType);callQuery(["req",json],"EXPENSE_EXCEL",$)}function brandChk(){var brandList=($.mtBrand.getSelectedCodeList()||"");if(!brandList){MessageBoxShow("브랜드를 선택해 주세요.");return false}return true}function renderSearchData(ds){var colList=$.fcstList=ds.resultList[0];var cols=resetSearchGridColumns(colList,"");var dt=ds.resultList[1];$.grdExpense.resetColumns(cols);setDataGrid([$.grdExpense],dt,true);settingGridRowSpan()}function resetSearchGridColumns(colList,type){$.grdExpense.removeColumns();var cols=[];$.colNameList=[];getBaseSearchColumnsQ1(cols);var iLen=colList.length;var iCount=1;var groupCnt=0;for(var i=0;i<iLen;i++){var rowData=colList[i];var columnId="";var columnTxt=filteringData("DATE",rowData.ym);var groupTxt="";var header=[];var fy='<span style="color: blue; font-weight: bold;">(FY'+rowData.fy.substr(2,2)+")</span>";var yy=rowData.yyyy.substr(2,2)+"년";var mm=Number(rowData.mm)+"월";var isNowFy=(rowData.fy==$.dteFy.getValue());if(rowData.spread=="MONTH"){groupCnt++;columnId="ym"+iCount+"_"+rowData.half_gubun;cols.push(new FingerDataGridColumn(columnId,78,"right","int","<br>"+yy+"<br>"+mm,{format:"int",sort:null}));if(groupCnt==12){getBaseSearchColumnsQ2(cols,rowData.half_gubun,fy,isNowFy);groupCnt=0}}else{columnId="ym_"+rowData.half_gubun;groupTxt="FY"+columnTxt.substr(0,2);getBaseSearchColumnsQ3(cols,columnId,groupTxt,fy,isNowFy)}$.colNameList[i]=columnId;iCount++}return cols}function renderExcelData(ds){var colList=ds.resultList[0];var cols=resetExcelGridColumns(colList,"EXCEL");var dt=ds.resultList[1];$.grdExcel.resetColumns(cols);setDataGrid([$.grdExcel],dt,true)}function settingGridRowSpan(){var iLen=$.grdExpense.getRowCount();for(var i=0;i<iLen;i++){var rowData=$.grdExpense.getValue(i);if(!rowData.dept_code&&!rowData.budget_code){$.grdExpense.addSpan(rowData.id,"product_short_name",4,1,"전체 TOTAL",null);$.grdExpense.selectRow(rowData.id,false,"product_short_name")}if(rowData.dept_code&&!rowData.budget_code){$.grdExpense.addSpan(rowData.id,"dept_name",3,1,rowData.dept_name+" TOTAL",null);$.grdExpense.selectRow(rowData.id,false,"dept_name")}}$.grdExpense.clearSelect()}function resetExcelGridColumns(colList,type){var cols=[];getBaseExcelColumns(cols);var iCount=1;for(var i=0;i<colList.length;i++){var rowData=colList[i];var columnId="ym"+iCount+"_"+rowData.half_gubun;var columnTxt=filteringData("DATE",rowData.ym);var header=[];cols.push(new FingerDataGridColumn(columnId,76,"right","int",columnTxt,{format:"int",sort:null}));iCount++}return cols}function getBaseSearchColumnsQ1(arr){var fy=$.dteFy.getValue();var colName=["FT"+fy.toString().substr(2,2),"BUD"];arr.push(new FingerDataGridColumn("product_short_name",80,"left","center","품목",{readonly:true,sort:null}));arr.push(new FingerDataGridColumn("dept_name",90,"left","string","부서",{readonly:true,sort:null}));arr.push(new FingerDataGridColumn("budget_name",110,"left","string","예산항목",{readonly:true,sort:null}));arr.push(new FingerDataGridColumn("ucoa_name",110,"left","string","U-CoA",{readonly:true,sort:null}));arr.push(new FingerDataGridColumn("fy_target",80,"center","string",colName,{readonly:true,sort:null}))}function getBaseSearchColumnsQ2(arr,suffix,fy,isNowFy){suffix=suffix.substr(0,1)+"Y";arr.push(new FingerDataGridColumn("first_half_"+suffix,80,"right","int","<br>"+fy+"<br>상반기",{readonly:true,format:"int",sort:null,sideColumn:true}));arr.push(new FingerDataGridColumn("second_half_"+suffix,80,"right","int","<br>"+fy+"<br>하반기",{readonly:true,format:"int",sort:null,sideColumn:true}));arr.push(new FingerDataGridColumn("year_"+suffix,80,"right","int","<br>"+fy+"<br>FCST",{readonly:true,format:"int",sort:null,sideColumn:true}));arr.push(new FingerDataGridColumn("incremental_"+suffix,80,"right","int","<br>"+fy+"<br>Incremental",{readonly:true,format:"percent_1",sort:null,sideColumn:true}));arr.push(new FingerDataGridColumn("gr_rate_"+suffix,80,"right","int","<br>"+fy+"<br>G/R",{readonly:true,format:"percent_1",sort:null,sideColumn:true}))}function getBaseSearchColumnsQ3(arr,columnId,groupTxt,fy,isNowFy){arr.push(new FingerDataGridColumn("year_"+columnId,80,"right","int","<br>"+fy+"<br>FCST",{format:"int",sort:null,sideColumn:true}));arr.push(new FingerDataGridColumn("incremental_"+columnId,80,"right","int","<br>"+fy+"<br>Incremental",{readonly:true,format:"percent_1",sort:null,sideColumn:true}));arr.push(new FingerDataGridColumn("gr_rate_"+columnId,80,"right","int","<br>"+fy+"<br>G/R",{readonly:true,format:"percent_1",sort:null,sideColumn:true}))}function getBaseExcelColumns(arr){arr.push(new FingerDataGridColumn("product_short_name",80,"center","string","품목",{readonly:true,sort:null}));arr.push(new FingerDataGridColumn("dept_name",90,"center","string","부서",{readonly:true,sort:null}));arr.push(new FingerDataGridColumn("budget_name",110,"center","string","예산항목",{readonly:true,sort:null}));arr.push(new FingerDataGridColumn("ucoa_name",110,"center","string","U-CoA",{readonly:true,sort:null}))}function filteringData(type,value){var str="";if(type=="DATE"){var yyyy=value.substr(2,2);var mm=value.substr(4,2);if(mm=="YR"){mm=""}else{mm=Number(mm)+"월"}str=yyyy+"년 "+mm}return str}function excelUploadParam(dt){var iLen=dt.length;var productNameList=[];var deptNameList=[];var budgetNameList=[];var amtList=[];for(var i=0;i<iLen;i++){var rowData=dt[i];var amtDetail=[];productNameList[i]=rowData.product_short_name;deptNameList[i]=rowData.dept_name;budgetNameList[i]=rowData.budget_name;var amtObj=Object.keys(rowData);var kLen=amtObj.length;var iCount=0;for(var k=0;k<kLen;k++){var col=amtObj[k];if(col.indexOf("ym")>-1){amtDetail[iCount]=rowData[col].replace(",","");iCount++}}amtList[i]=amtDetail.join("δ")}return[productNameList.join("|"),deptNameList.join("|"),budgetNameList.join("|"),amtList.join("|"),]}$.calcFn={calcTotalSum:function(dt,rowData,cInd,keyName,type){var filterData=dt.filter(function(o){return o[keyName]==rowData[keyName]&&o.budget_code});var sum=filterData.reduce(function(d,f){var obj={};obj[cInd]=(Number(d[cInd])||0)+(Number(f[cInd])||0);return obj});return sum[cInd]||null},calcHalfSum:function(colList,rId,gubun){var sum=0;var len=colList.length;for(var i=0;i<len;i++){var col=colList[i];if(col.indexOf(gubun)>-1){sum+=Number($.grdExpense.getValue(rId,col))}}return sum||null},bindGroupSum:function(dt,rowData,cInd,keyName,type){var filterData=[];if(type=="DEPT"){filterData=dt.filter(function(o){return o[keyName]==rowData[keyName]&&!o.budget_code})}else{filterData=dt.filter(function(o){return !o.dept_code})}if(!filterData.length){return}var groupRow=filterData[0];var sum=this.calcTotalSum(dt,rowData,cInd,keyName,"");$.grdExpense.setValue(groupRow.id,cInd,sum)},bindHalfSum:function(rowData,rId,gubun,suffix){var filterData=$.colNameList.filter(function(o){return o.substr(o.length-2,1)==gubun});var firstHalfSum=null;var secondHalfSum=null;var yearSum=null;firstHalfSum=this.calcHalfSum(filterData,rId,"F");secondHalfSum=this.calcHalfSum(filterData,rId,"S");yearSum=(firstHalfSum+secondHalfSum)||null;$.grdExpense.setValue(rId,"first_half_"+suffix,firstHalfSum);$.grdExpense.setValue(rId,"second_half_"+suffix,secondHalfSum);$.grdExpense.setValue(rId,"year_"+suffix,yearSum)}};$.init=function(host,args){$.panMain=new FingerPanel(host,"panMain",0,0,1200,905);$.panMain.setText("");$.panMain.setBottomLine(true);$.panTop=new FingerPanel(host,"panTop",0,0,1200,145);$.panTop.setText("");$.panTop.setBottomLine();$.lblFy=new FingerLabel(host,"lblFy",0,15,100,20);$.lblFy.setText("연도");$.dteFy=new FingerDateEdit(host,"dteFy",105,15,140,20);$.lblVersion=new FingerLabel(host,"lblVersion",255,15,100,20);$.lblVersion.setText("버전");$.cmbVersion=new FingerComboBox(host,"cmbVersion",360,15,140,20);$.lblBrand=new FingerLabel(host,"lblBrand",505,15,100,20);$.lblBrand.setText("품목");$.mtBrand=new FingerMultiSelect(host,"mtBrand",610,15,225,110);$.btnSearch=new FingerButton(host,"btnSearch",875,15,80,20);$.btnSearch.setText("조회");$.btnExcelDownload=new FingerButton(host,"btnExcelDownload",975,15,120,20);$.btnExcelDownload.setText("양식다운로드");$.btnExcelUpload=new FingerButton(host,"btnExcelUpload",1080,15,125,20);$.btnExcelUpload.setText("엑셀업로드");$.panExpense=new FingerPanel(host,"panExpense",0,155,1200,720);$.panExpense.setText("비용예산");$.panExpense.setBottomLine(true);$.grdExpense=new FingerDataGrid(host,"grdExpense",0,0,1200,675);$.grdExcel=new FingerDataGrid(host,"grdExcel",5,5,1,1);$.panTop.setBorder(true);$.panExpense.addButton("btnExcelDown","Excel");$.panExpense.addButton("btnCancel","승인요청취소");$.panExpense.addButton("btnApproval","승인요청");$.panExpense.setButtonAction("btnExcelDown","excel_down");$.panExpense.setButtonAction("btnCancel","custom",100);$.panExpense.setButtonAction("btnApproval","custom",80);$.panExpense.addButtons(["btnTemp"]);$.dteFy.setDateFormat("yyyy");$.dteFy.setAllowBlank(false,"연도");$.cmbVersion.setAllowBlank(false,"버전");$.cmbVersion.setEmptyRow(true);$.cmbVersion.setColumnConfig([{id:"sub_code",width:110},{id:"code_name",width:130},{id:"extra_field1",width:0.1},{id:"extra_field2",width:0.1},{id:"extra_field3",width:0.1}]);$.mtBrand.setTitle("전체");$.grdExpense.setColumns([]);$.grdExpense.init({scroll:"xy",select:"cell",leftSplit:4,headerRowHeight:40});$.grdExpense.setBorder(false);$.grdExpense.setEditable(true);$.grdExcel.setColumns([]);$.grdExcel.init();$.grdExcel.setVisible(false);$.host=host;$.args=args};$.start=function(){$.panMain.add($.panTop);$.panMain.add($.panExpense);$.panMain.add($.grdExcel);$.panTop.add($.lblFy);$.panTop.add($.dteFy);$.panTop.add($.lblVersion);$.panTop.add($.cmbVersion);$.panTop.add($.lblBrand);$.panTop.add($.mtBrand);$.panTop.add($.btnSearch);$.panTop.add($.btnExcelDownload);$.panTop.add($.btnExcelUpload);$.panExpense.add($.grdExpense);getFYDate();searchBrand("Q_BRAND");if($.isDebug){$.dteFy.setValue("2019")}};$.callback=function(type,ds){if(type=="EXPENSE_VERSION"){$.cmbVersion.clear();if(ds&&ds.errorCode=="MSG0001"){setComboBind([$.cmbVersion],ds)}}else{if(type=="EXPENSE_BRAND"){$.mtBrand.setData1(ds.resultList[0],"product_code","product_name");$.mtBrand.setAllCheck(true)}else{if(type=="EXPENSE_LIST"){$.fcstColumns=ds.resultList[0];renderSearchData(ds)}else{if(type=="EXPENSE_EXCEL"){renderExcelData(ds);$.grdExcel.excelDown("비용예산수립 양식")}}}}};$.update=function(args){$.args=args};$.executeScript=function(script){eval(script)};$.fingerbutton_click=function(id){if(id=="btnSearch"){searchList("Q","")}else{if(id=="btnExcelDownload"){if(!$.cmbVersion.getValue()){MessageBoxShow("예산버전을 선택해 주세요.");return}if(!brandChk()){return}downloadExcelForm("Q_EXCEL")}else{if(id=="btnExcelUpload"){if(!$.cmbVersion.getValue()){MessageBoxShow("예산버전을 선택해 주세요.");return}if(!brandChk()){return}$.popUpCallId=id;var param={};param.placeHolder="내용만 복사해서 붙여넣으세요.\r\n첫 행에 첫 열은 필수로 입력하셔야 합니다.";param.cId=["product_short_name","dept_name","budget_name","ucoa_name"];var ds=searchFCST("Q_FCST");var dt=ds.resultList[0];var iCount=1;for(var i=0;i<dt.length;i++){var rowData=dt[i];var colName="";if(rowData.spread=="MONTH"){colName="ym"+iCount+"_"+rowData.half_gubun}else{colName="year_ym"+iCount+"_"+rowData.half_gubun}param.cId.push(colName);iCount++}var dt=[{rowType:"N",product_short_name:"-",dept_name:"비서",budget_name:"도서인쇄비_도서구입",ucoa_name:"Subscriptions/memberships",ym1_1F:"1000",ym2_1F:"2000",ym3_1F:"3000",ym4_1F:"",ym5_1F:"",ym6_1F:"",ym7_1S:"2000",ym8_1S:"",ym9_1S:"",ym10_1S:"",ym11_1S:"",ym12_1S:"2000",year_ym13_2Y:"3000",year_ym14_3Y:"",year_ym15_4Y:"",year_ym16_5Y:""},{rowType:"N",product_short_name:"-",dept_name:"비서",budget_name:"복리후생비_소팀운영비",ucoa_name:"Meetings",ym1_1F:"4000",ym2_1F:"5000",ym3_1F:"6000",ym4_1F:"",ym5_1F:"",ym6_1F:"",ym7_1S:"5000",ym8_1S:"",ym9_1S:"",ym10_1S:"",ym11_1S:"",ym12_1S:"",year_ym13_2Y:"",year_ym14_3Y:"",year_ym15_4Y:"",year_ym16_5Y:""},{rowType:"N",product_short_name:"-",dept_name:"비서",budget_name:"복리후생비_운영비_사장",ucoa_name:"Meetings",ym1_1F:"",ym2_1F:"",ym3_1F:"",ym4_1F:"",ym5_1F:"",ym6_1F:"",ym7_1S:"",ym8_1S:"",ym9_1S:"",ym10_1S:"",ym11_1S:"",ym12_1S:"",year_ym13_2Y:"",year_ym14_3Y:"",year_ym15_4Y:"",year_ym16_5Y:""},{rowType:"N",product_short_name:"-",dept_name:"비서",budget_name:"복리후생비_운영비_주재원",ucoa_name:"Meetings",ym1_1F:"",ym2_1F:"",ym3_1F:"",ym4_1F:"",ym5_1F:"",ym6_1F:"",ym7_1S:"",ym8_1S:"",ym9_1S:"",ym10_1S:"",ym11_1S:"",ym12_1S:"",year_ym13_2Y:"",year_ym14_3Y:"",year_ym15_4Y:"",year_ym16_5Y:""}];searchList("Q_UPLOAD",excelUploadParam(dt))}}}};$.fingermultiselect_checkchange=function(id,index){};$.fingermultiselect_itemchange=function(id){};$.fingerbuttonedit_click=function(id){};$.fingerbuttonedit_change=function(id,value){};$.fingerbuttonedit_keypress=function(id,value){};$.fingerbuttonedit_lostfocus=function(id,value){};$.fingercheckbox_change=function(id,value){};$.fingercombobox_change=function(id,value){};$.fingerdateedit_click=function(id){};$.fingerdateedit_change=function(id,value){if(id=="dteFy"){if(!value){return}searchBudgetVersion("Q_VER")}};$.fingerdatagrid_itemclick=function(id,rId,cInd){};$.fingerdatagrid_selectionchange=function(id,rId){};$.fingerdatagrid_cellvaluechange=function(id,rId,cInd,nValue,oValue){if(id=="grdExpense"){if(cInd.indexOf("ym")>-1){var inputData=nValue.toString();if(isNaN(inputData)){$.grdExpense.setValue(rId,cInd,oValue==""?"":oValue);return}else{$.grdExpense.setValue(rId,cInd,Math.floor(nValue))}var rowData=$.grdExpense.getValue(rId);var dt=$.grdExpense.getAllRows();$.calcFn.bindGroupSum(dt,rowData,cInd,"dept_code","DEPT");$.calcFn.bindGroupSum(dt,rowData,cInd,"ver_code","ALL");var len=cInd.length;var gubun=cInd.substr(len-2,1);var suffix="";if(cInd.indexOf("year")>-1){suffix="ym_"+gubun+"Y"}else{suffix=gubun+"Y";$.calcFn.bindHalfSum(rowData,rId,gubun,suffix);$.calcFn.bindGroupSum(dt,rowData,"first_half_"+suffix,"dept_code","DEPT");$.calcFn.bindGroupSum(dt,rowData,"second_half_"+suffix,"dept_code","DEPT");$.calcFn.bindGroupSum(dt,rowData,"year_"+suffix,"dept_code","DEPT");$.calcFn.bindGroupSum(dt,rowData,"first_half_"+suffix,"ver_code","ALL");$.calcFn.bindGroupSum(dt,rowData,"second_half_"+suffix,"ver_code","ALL");$.calcFn.bindGroupSum(dt,rowData,"year_"+suffix,"ver_code","ALL")}}}};$.fingerdatagrid_rowdblclicked=function(id,rId,cInd){};$.fingerdatagrid_celllink_click=function(e,gridid,rId,cId,value){};$.fingerdatagrid_popupcelldblclicked=function(id,rId,cInd){};$.fingerdatagrid_drag=function(id,sId,tId,sObj,tObj,sInd,tInd){};$.fingeredit_change=function(id,value){};$.fingeredit_keypress=function(id,value){};$.fingeredit_lostfocus=function(id,value){};$.fingerimage_click=function(id){};$.fingerlayout_panelresizefinish=function(id){};$.fingerlayout_resizefinish=function(id){};$.fingerpanel_button_click=function(panelId,btnId){};$.fingerpopup_close=function(id){var popResult=g_popupStack.shareData;if(popResult){if(id=="popPaste"){var dt=popResult.paste;if(!dt||!dt.length){MessageBoxShow("업로드 진행 중 오류가 발생했습니다.");return}console.log(JSON.stringify(dt))}}};$.fingerpopup2_close=function(id){};$.fingerradiobox_change=function(id,value){};$.fingertab_selectionchange=function(id,tabid){};$.fingertab_ontabclose=function(id,tabid){};$.fingertree_select=function(id,value){};$.fingertree_dblclick=function(id,nodeid){};$.fingertree_refresh=function(id){};$.fingerscheduler_before_event_changed=function(id,event_object,native_event,is_new,unmodified_event){};$.fingerscheduler_before_event_delete=function(id,event_id,event_object){};$.fingerscheduler_event_click=function(id,event_id,event_object,native_event_object){};$.fingerscheduler_ready=function(id){};$.fingerscheduler_before_event_created=function(id,start_date,end_date){};$.fingerscheduler_view_display=function(id,view){};$.fingerscheduler_event_reg=function(id,obj){};$.fingerfilepanel_upload_click=function(id,fileId,fileName){};$.fingerfilepanel_download_click=function(id,fileId,fileName){};$.fingerfilepanel_delete_click=function(id,fileId,fileName){}};</script>