<script>function Main(){var $=this;$.host=null;$.panMain=null;$.panTop=null;$.panList=null;$.grdList=null;$.lblDraftDate=null;$.dteStartDate=null;$.lblEx1=null;$.dteEndDate=null;$.lblEmp=null;$.bteEmp=null;$.btnPdfView=null;$.btnSendMail=null;$.lblInstn=null;$.txtInst=null;$.lblCprStatus=null;$.cmbCprStatus=null;$.lblMailStatus=null;$.cmbMailStatus=null;$.btnSearch=null;$.lblHcp=null;$.txtHcp=null;$.session=g_main.session.obj;$.varWfCprId="";$.provideSampleData=[];$.sympData=[];$.clinicData=[];$.productMultiData=[];$.productSingleData=[];$.pmsData=[];function addComboData(){var ds={resultList:[[{sub_code:"Y",code_name:"승인"},{sub_code:"N",code_name:"미승인"}],[{sub_code:"Y",code_name:"발송"},{sub_code:"N",code_name:"미발송"}]]};setComboBind([$.cmbCprStatus,$.cmbMailStatus],ds);$.grdList.setColumnDropDownList("cpr_status",ds.resultList[0]);$.grdList.setColumnDropDownList("send_yn",ds.resultList[1])}function createJson_Q(workType){var json=createExecuteParamInfo("P_crmCPExpenseReportMaster_Q",[workType,"#DeptCode#","#UserID#",$.varWfCprId,$.dteStartDate.getValue(),$.dteEndDate.getValue(),$.bteEmp.getValue(),$.txtHcp.getValue()||"",$.txtInst.getValue()||"",$.cmbCprStatus.getValue()||"",$.cmbMailStatus.getValue()||""]);return json}function createJson_S(workType){var json=createExecuteParamInfo("P_crmWFExpenseReportReq_S",[workType,$.varWfCprId,"","","","","","","",""]);return json}function searchList(workType){if(!$.panTop.validateControls()){return}var json=createJson_Q(workType);callQuery(["req",json],workType,$)}function updateSendMailDate(workType){var bResult=false;var json=createJson_S(workType);var ds=callExecuteSync(["req",json],workType,$);if(ds){bResult=true}return bResult}function createMailForm(dt){var ds="";var params="";var docYn="Y";var email=dt.email_address;var mailTo=dt.contact_name;var emailMR=dt.req_email_address;var mailMrTo=dt.req_user;if(!email){MessageBoxShow("고객의 메일주소가 없어서 메일전송이 불가합니다.");return}var fileName="경제적이익제공_보고서";var cprParam=createCprData();if(Object.keys(cprParam).length<1){var msg=dt.contact_name+" 고객에 대한<br>"+dt.report_term+" 기간 동안의<br>이익 제공 내역이 존재하지 않습니다.";docYn="N"}params={param:JSON.stringify(cprParam),toAddr:email,toAddrPs:mailTo,nowDay:getToday("."),companyName:dt.company_name,hcpName:dt.contact_name,date:dt.report_term,subject:"[Confidential] 한국아스텔라스제약㈜ ─ 경제적이익제공내역",contents:createContentForm(dt,1,docYn),subjectPw:"[Confidential] 한국아스텔라스제약㈜ ─ 경제적이익제공내역 password",contentsPw:createContentForm(dt,2,docYn),fileName:fileName,docYn:docYn,directYn:"N"};ds=sendCprMail(params);if(ds&&ds.resultType){if(!emailMR){if(updateSendMailDate("U_MAIL")){initData();searchList("Q1");MessageBoxShow("메일이 정상적으로 발송되었습니다.")}}else{params={toAddr:emailMR,toAddrPs:mailMrTo,subject:dt.company_name+" "+dt.contact_name+" 고객에게 경제적이익 제공에 따른 지출보고서 내역을 메일발송 하였습니다.",contents:createContentForm(dt,3,docYn),directYn:"Y"};ds=sendCprMail(params);if(ds&&ds.resultType){if(updateSendMailDate("U_MAIL")){initData();searchList("Q1");MessageBoxShow("메일이 정상적으로 발송되었습니다.")}}else{MessageBoxShow(dt.contact_name+" 고객에게 정상적으로 메일이 발송되었으나<br>MR에게 메일을 발송하는 도중 오류가 발송하였습니다. <br>관리자에게 문의하여 주시기 바랍니다.")}}}else{MessageBoxShow("메일을 발송하는 도중 오류가 발생 하였습니다.<br><br><br>네트워크를 확인 하시거나 <br>관리자에게 문의하여 주시기 바랍니다.")}}function sendCprMail(params){var result=jQuery.ajax({accepts:{json:"application/json; charset=UTF-8"},type:"POST",async:false,url:g_ContextPath+"/pdf/mailPdf.do",data:params}).responseText;return JSON.parse(result)}function createCprData(){var cprParam={};if($.provideSampleData.length){cprParam.p1=$.data1}if($.sympData.length){cprParam.p2=$.sympData}if($.clinicData.length){var data=$.clinicData;var afterData=[];var obj={};var before_no="";var study_main_name="",study_main_company="";var row_cnt=1,rnum=0;var approveNo=[],mainNameList=[],mainCompanyList=[];for(var index=0;index<data.length;index++){var changeObj={};var bo=true;if(before_no==data[index].study_approve_no){}else{row_cnt=1;rnum++;before_no=data[index].study_approve_no;approveNo.push(before_no)}if(data[index].study_main_yn=="Y"){study_main_name=data[index].contact_name;study_main_company=data[index].company_name;mainNameList.push(study_main_name);mainCompanyList.push(study_main_company);bo=false;if(data[index].tot_cnt==1){changeObj.rnum=rnum;changeObj.study_name=data[index].study_name;changeObj.study_type=data[index].study_type;changeObj.study_approve_no=data[index].study_approve_no;changeObj.study_approve_date=data[index].study_approve_date;changeObj.main_contact_name=study_main_name;changeObj.main_company_name=study_main_company;changeObj.contact_name="";changeObj.company_name="";changeObj.study_total_amt=data[index].study_total_amt;changeObj.product_name=data[index].product_name;changeObj.product_qty=data[index].product_qty;changeObj.contract_date=data[index].contract_date;changeObj.row_cnt=row_cnt;changeObj.tot_cnt=data[index].tot_cnt;bo=true}}else{changeObj.rnum=rnum;changeObj.study_name=data[index].study_name;changeObj.study_type=data[index].study_type;changeObj.study_approve_no=data[index].study_approve_no;changeObj.study_approve_date=data[index].study_approve_date;changeObj.main_contact_name="";changeObj.main_company_name="";changeObj.contact_name=data[index].contact_name||"";changeObj.company_name=data[index].company_name||"";changeObj.study_total_amt=data[index].study_total_amt;changeObj.product_name=data[index].product_name;changeObj.product_qty=data[index].product_qty;changeObj.contract_date=data[index].contract_date;changeObj.row_cnt=row_cnt;changeObj.tot_cnt=data[index].tot_cnt-1}row_cnt++;if(bo){afterData.push(changeObj)}}for(var index=0;index<afterData.length;index++){var rowData=afterData[index];for(var cnt=0;cnt<approveNo.length;cnt++){if(rowData.study_approve_no==approveNo[cnt]){rowData.main_contact_name=mainNameList[cnt];rowData.main_company_name=mainCompanyList[cnt]}}if(rowData.tot_cnt==1&&row_cnt!=1){rowData.row_cnt=1}}cprParam.p3=afterData}if($.productMultiData.length){cprParam.p4=$.productMultiData}if($.productSingleData.length){cprParam.p5=$.productSingleData}if($.pmsData.length){cprParam.p6=$.pmsData}return cprParam}function initData(){$.provideSampleData=[];$.sympData=[];$.clinicData=[];$.productMultiData=[];$.productSingleData=[];$.pmsData=[]}function createContentForm(dt,type,docYn){var html="";if(type==1){html+="<span style='font-size: 0.9em;'>수신자 귀하</span><br><br><span style='font-size: 0.9em;'>요청하신 귀하의 경제적이익제공 내역을 확인해 주시기 바랍니다. 첨부파일을 확인해 주십시오.</span><br><br><table style='width: 600px; border-collapse: collapse; border-spacing: 0; empty-cells:show;'><tr><td style='border: 1px solid; height: 30px; font-weight: 600;'>소 속 : "+dt.company_name+"</td></tr><tr><td style='border: 1px solid; height: 30px; font-weight: 600;'>성 함 : "+dt.contact_name+"</td></tr><tr><td style='border: 1px solid; height: 30px; font-weight: 600;'>기 간 : "+dt.report_term+"</td></tr></table><br><br>"+(docYn=="N"?"<span style='font-size: 0.9em;'>해당 기간에 내역이 존재하지 않습니다.</span><br><br>":"")+"<span style='font-size: 0.9em;'>보고서 내용에 대한 문의는 한국아스텔라스제약㈜ 영업담당자를 통해 접수해 주시기 바랍니다.</span><br><span style='font-size: 0.9em;'>감사합니다.</span><br><br><br><table style='width: 640px; border-collapse: collapse; border-spacing: 0; empty-cells:show; font-size: 0.7em; line-height: 19px; border-top: 1px solid;'><tr><td><br>서울시 강남구 학동로 401(청담동, 금하빌딩 6층) 한국아스텔라스제약㈜<br><br>위 전자우편에 포함된 정보는 위에 기재된 수신인만을 위해 발송되는 것으로서 보안을 유지해야 하는 정보 및 법률상 또는 다른 사유로 인하여 공개가 금지된 정보가 들어 있을 수 있습니다. 따라서 전송 오류로 인하여 귀하가 정당한 수신자가 아님에도 불구하고 본 이메일을 수신하였을 경우에는 법적으로 본 이메일의 내용을 제3자에게 유출하거나 어떠한 방식으로든 가공하여 사용하는 것이 금지되어 있음을 유의하셔야 합니다. 그러므로 잘못 수신된 경우에는 원본 및 사본과 그에 따른 첨부 문서를 모두 삭제하여 주시기 바랍니다.</td></tr>";"</table>"}else{if(type==2){html+="<span style='font-size: 0.9em;'>수신자 귀하,</span><br><br><span style='font-size: 0.9em;'>요청하신 귀하의 경제적이익제공 내역 확인을 위하여 다음의 password를 사용하십시오.</span><br><br><br><span style='font-size: 0.9em; font-weight: 600;'>Password : #password#</span><br><br><br><table style='width: 640px; border-collapse: collapse; border-spacing: 0; empty-cells:show; font-size: 0.7em; line-height: 19px; border-top: 1px solid;'><tr><td><br>서울시 강남구 학동로 401(청담동, 금하빌딩 6층) 한국아스텔라스제약㈜<br><br>위 전자우편에 포함된 정보는 위에 기재된 수신인만을 위해 발송되는 것으로서 보안을 유지해야 하는 정보 및 법률상 또는 다른 사유로 인하여 공개가 금지된 정보가 들어 있을 수 있습니다. 따라서 전송 오류로 인하여 귀하가 정당한 수신자가 아님에도 불구하고 본 이메일을 수신하였을 경우에는 법적으로 본 이메일의 내용을 제3자에게 유출하거나 어떠한 방식으로든 가공하여 사용하는 것이 금지되어 있음을 유의하셔야 합니다. 그러므로 잘못 수신된 경우에는 원본 및 사본과 그에 따른 첨부 문서를 모두 삭제하여 주시기 바랍니다.</td></tr>";"</table>"}else{html+="<span style='font-size: 0.9em;'>결재번호 : "+dt.wf_doc_id+"</span><br><span style='font-size: 0.9em;'>문서명 : "+dt.doc_title+"</span><br><span style='font-size: 0.9em;'>고객명 : "+dt.contact_name+"</span><br><span style='font-size: 0.9em;'>소속기관 : "+dt.company_name+"</span><br><span style='font-size: 0.9em;'>기간 : "+dt.report_term+"</span><br><br><span style='font-size: 0.9em;'>해당 문서가 메일로 전송되었습니다.</span>"}}return html}$.init=function(host,args){$.panMain=new FingerPanel(host,"panMain",0,0,1200,760);$.panMain.setText("");$.panMain.setBottomLine(true);$.panTop=new FingerPanel(host,"panTop",0,0,1200,85);$.panTop.setText("");$.panTop.setBottomLine(true);$.panList=new FingerPanel(host,"panList",0,95,1200,650);$.panList.setText("요청문서목록");$.panList.setBottomLine(true);$.grdList=new FingerDataGrid(host,"grdList",0,0,1200,605);$.lblDraftDate=new FingerLabel(host,"lblDraftDate",0,15,100,20);$.lblDraftDate.setText("기안일자");$.dteStartDate=new FingerDateEdit(host,"dteStartDate",105,15,140,20);$.lblEx1=new FingerLabel(host,"lblEx1",245,15,20,20);$.lblEx1.setText("~");$.dteEndDate=new FingerDateEdit(host,"dteEndDate",270,15,140,20);$.lblEmp=new FingerLabel(host,"lblEmp",400,15,100,20);$.lblEmp.setText("요청자");$.bteEmp=new FingerButtonEdit(host,"bteEmp",505,15,140,20);$.bteEmp.setText("");$.btnPdfView=new FingerButton(host,"btnPdfView",765,-40.5,140,30);$.btnPdfView.setText("보고서 미리보기");$.btnSendMail=new FingerButton(host,"btnSendMail",890,-40.5,160,30);$.btnSendMail.setText("고객 메일로 발송");$.lblInstn=new FingerLabel(host,"lblInstn",0,45,100,20);$.lblInstn.setText("요양기관");$.txtInst=new FingerEdit(host,"txtInst",105,45,305,20);$.lblCprStatus=new FingerLabel(host,"lblCprStatus",645,45,100,20);$.lblCprStatus.setText("결재상태");$.cmbCprStatus=new FingerComboBox(host,"cmbCprStatus",750,45,118,20);$.lblMailStatus=new FingerLabel(host,"lblMailStatus",865,45,100,20);$.lblMailStatus.setText("발송상태");$.cmbMailStatus=new FingerComboBox(host,"cmbMailStatus",970,45,110,20);$.btnSearch=new FingerButton(host,"btnSearch",1120,45,80,20);$.btnSearch.setText("조회");$.lblHcp=new FingerLabel(host,"lblHcp",400,45,100,20);$.lblHcp.setText("고객");$.txtHcp=new FingerEdit(host,"txtHcp",505,45,143,20);$.panTop.setBorder(true);$.cmbCprStatus.setEmptyRow(true);$.cmbMailStatus.setEmptyRow(true);$.dteStartDate.setAllowBlank(false,"시작일");$.dteEndDate.setAllowBlank(false,"종료일");$.grdList.colIdx=$.grdList.setColumns([new FingerDataGridColumn("wf_doc_id",125,"left","string","결재번호"),new FingerDataGridColumn("cpr_status",70,"left","string","결재상태"),new FingerDataGridColumn("doc_title",168,"left","string","문서명"),new FingerDataGridColumn("company_name",135,"left","string","소속기관"),new FingerDataGridColumn("contact_name",70,"left","string","고객명"),new FingerDataGridColumn("report_term",160,"left","string","보고서 기간"),new FingerDataGridColumn("email_address",120,"left","string","메일 주소"),new FingerDataGridColumn("send_yn",95,"left","string","메일발송여부"),new FingerDataGridColumn("mail_send_date",85,"left","string","발송일시",{format:"s_ymd"}),new FingerDataGridColumn("req_date",85,"left","string","요청일시",{format:"s_ymd"}),new FingerDataGridColumn("req_user",70,"left","string","요청자")]);$.grdList.init({panel:$.panList,scroll:"xy"});$.grdList.setBorder(false);$.host=host;$.args=args};$.start=function(){$.panMain.add($.panTop);$.panMain.add($.panList);$.panTop.add($.lblDraftDate);$.panTop.add($.dteStartDate);$.panTop.add($.lblEx1);$.panTop.add($.dteEndDate);$.panTop.add($.lblEmp);$.panTop.add($.bteEmp);$.panTop.add($.lblInstn);$.panTop.add($.txtInst);$.panTop.add($.lblCprStatus);$.panTop.add($.cmbCprStatus);$.panTop.add($.lblMailStatus);$.panTop.add($.cmbMailStatus);$.panTop.add($.btnSearch);$.panTop.add($.lblHcp);$.panTop.add($.txtHcp);$.panList.add($.grdList);$.panList.add($.btnPdfView);$.panList.add($.btnSendMail);relocateChildIndexInPanel([$.panTop]);addComboData();$.dteStartDate.setValue(getToday().substr(0,6)+"01");$.dteEndDate.setValue(getToday())};$.callback=function(type,ds){if(type=="Q1"){setDataGrid([$.grdList],ds);log("-->"+$.varWfCprId);if($.grdList.getRowCount()>0){if($.varWfCprId){var rIndex=$.grdList.getGridRowIndex("wf_doc_id",$.varWfCprId);$.grdList.selectRow(rIndex)}}}else{if(type=="Q_REPORT"){if(ds){$.provideSampleData=ds.resultList[0];$.sympData=ds.resultList[1];$.clinicData=ds.resultList[2];$.productMultiData=ds.resultList[3];$.productSingleData=ds.resultList[4];$.pmsData=ds.resultList[5]}}}};$.update=function(args){$.args=args};$.executeScript=function(script){eval(script)};$.fingerbutton_click=function(id){if(id=="btnSearch"){initData();$.varWfCprId="";searchList("Q1")}else{if(id=="btnPdfView"){var rId=$.grdList.getSelectedRowIdx();if(!rId){MessageBoxShow("미리보기 할 문서를 선택해 주세요.");return}var dt=$.grdList.getValue(rId);var cprParam=createCprData();if(Object.keys(cprParam).length<1){var msg=dt.contact_name+" 고객에 대한<br>"+dt.report_term+" 기간 동안의<br>이익 제공 내역이 존재하지 않습니다.";MessageBoxShow(msg);return}windowOpen("/pdf/openPdf.do",{param:JSON.stringify(cprParam),nowDay:getToday("."),companyName:dt.company_name,hcpName:dt.contact_name,date:dt.report_term})}else{if(id=="btnSendMail"){var rId=$.grdList.getSelectedRowIdx();if(!rId){MessageBoxShow("메일을 발송할 문서를 선택해 주세요.");return}var dt=$.grdList.getValue(rId);var msg=dt.contact_name+"고객의<br>"+dt.doc_title+" 문서를<br>메일로 발송하시겠습니까?";confirmBoxShow(msg,function(){if(g_main.msgShare==true){createMailForm(dt)}})}}}};$.fingermultiselect_checkchange=function(id,index){};$.fingermultiselect_itemchange=function(id){};$.fingerbuttonedit_click=function(id){$.popUpCallId=id;if(id=="bteEmp"){var param={emp_name:$.bteEmp.getText()||"",searchAll:"N"};g_main.openPopup("popEmp.html","popEmp","",0,0,"","",param,"","")}};$.fingerbuttonedit_change=function(id,value){};$.fingerbuttonedit_keypress=function(id,value){if(id=="bteEmp"){if(value==8){$.bteEmp.setText("");$.bteEmp.setValue("")}}};$.fingerbuttonedit_lostfocus=function(id,value){};$.fingercheckbox_change=function(id,value){};$.fingercombobox_change=function(id,value){};$.fingerdateedit_click=function(id){};$.fingerdateedit_change=function(id,value){if(id=="dteStartDate"){var endDate=$.dteEndDate.getValue();if(value>endDate){$.dteEndDate.setValue(value)}}else{if(id=="dteEndDate"){var startDate=$.dteStartDate.getValue();if(value<startDate){$.dteStartDate.setValue(value)}}}};$.fingerdatagrid_itemclick=function(id,rId,cInd){};$.fingerdatagrid_selectionchange=function(id,rId){if(id=="grdList"){initData();var dt=$.grdList.getValue(rId);$.varWfCprId=dt.wf_doc_id;if(dt.cpr_status=="N"){$.btnPdfView.setEnable(false);$.btnSendMail.setEnable(false)}else{$.btnPdfView.setEnable(true);$.btnSendMail.setEnable(true);searchList("Q_REPORT")}}};$.fingerdatagrid_cellvaluechange=function(id,rId,cInd,nValue,oValue){};$.fingerdatagrid_rowdblclicked=function(id,rId,cInd){};$.fingerdatagrid_celllink_click=function(e,gridid,rId,cId,value){};$.fingerdatagrid_popupcelldblclicked=function(id,rId,cInd){};$.fingerdatagrid_drag=function(id,sId,tId,sObj,tObj,sInd,tInd){};$.fingeredit_change=function(id,value){};$.fingeredit_keypress=function(id,value){if((id=="txtInst"||id=="txtHcp")&&value=="13"){initData();$.varWfCprId="";searchList("Q1")}};$.fingeredit_lostfocus=function(id,value){};$.fingerimage_click=function(id){};$.fingerlayout_panelresizefinish=function(id){};$.fingerlayout_resizefinish=function(id){};$.fingerpanel_button_click=function(panelId,btnId){};$.fingerpopup_close=function(id){var popResult=g_popupStack.shareData;if(popResult){if(id=="popEmp"){if($.popUpCallId=="bteEmp"){$.bteEmp.setText(popResult.emp_name);$.bteEmp.setValue(popResult.employee_id)}}}};$.fingerpopup2_close=function(id){};$.fingerradiobox_change=function(id,value){};$.fingertab_selectionchange=function(id,tabid){};$.fingertab_ontabclose=function(id,tabid){};$.fingertree_select=function(id,value){};$.fingertree_dblclick=function(id,nodeid){};$.fingertree_refresh=function(id){};$.fingerscheduler_before_event_changed=function(id,event_object,native_event,is_new,unmodified_event){};$.fingerscheduler_before_event_delete=function(id,event_id,event_object){};$.fingerscheduler_event_click=function(id,event_id,event_object,native_event_object){};$.fingerscheduler_ready=function(id){};$.fingerscheduler_before_event_created=function(id,start_date,end_date){};$.fingerscheduler_view_display=function(id,view){};$.fingerscheduler_event_reg=function(id,obj){};$.fingerfilepanel_upload_click=function(id,fileId,fileName){};$.fingerfilepanel_download_click=function(id,fileId,fileName){};$.fingerfilepanel_delete_click=function(id,fileId,fileName){}};</script>